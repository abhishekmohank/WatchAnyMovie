{"version":3,"file":"adblocker.umd.min.js","sources":["../adblocker.ts"],"sourcesContent":["/*!\n * Copyright (c) 2017-2019 Cliqz GmbH. All rights reserved.\n *\n * This Source Code Form is subject to the terms of the Mozilla Public\n * License, v. 2.0. If a copy of the MPL was not distributed with this\n * file, You can obtain one at https://mozilla.org/MPL/2.0/.\n */\n\nexport type Lifecycle = 'start' | 'dom-update';\n\nexport interface IBackgroundCallback {\n  classes: string[];\n  hrefs: string[];\n  ids: string[];\n  lifecycle: Lifecycle;\n}\n\nexport interface IMessageFromBackground {\n  active: boolean;\n  scripts: string[];\n  styles: string;\n  extended: string[];\n}\n\nexport interface DOMElement {\n  href?: string | SVGAnimatedString | null;\n  nodeType?: number;\n  localName?: string;\n  id?: string;\n  classList?: DOMTokenList;\n  querySelectorAll?: ParentNode['querySelectorAll'];\n}\n\nexport function getDOMElementsFromMutations(mutations: MutationRecord[]): DOMElement[] {\n  // Accumulate all nodes which were updated in `nodes`\n  const nodes: DOMElement[] = [];\n  for (const mutation of mutations) {\n    if (mutation.type === 'attributes') {\n      nodes.push(mutation.target);\n    } else if (mutation.type === 'childList') {\n      for (const addedNode of mutation.addedNodes) {\n        nodes.push(addedNode);\n\n        const addedDOMElement: DOMElement = addedNode;\n        if (addedDOMElement.querySelectorAll !== undefined) {\n          nodes.push(...addedDOMElement.querySelectorAll('[id],[class],[href]'));\n        }\n      }\n    }\n  }\n  return nodes;\n}\n\n/**\n * WARNING: this function should be self-contained and not rely on any global\n * symbol. That constraint needs to be fulfilled because this function can\n * potentially be injected in content-script (e.g.: see PuppeteerBlocker for\n * more details).\n */\nexport function extractFeaturesFromDOM(\n  elements: DOMElement[],\n): {\n  classes: string[];\n  hrefs: string[];\n  ids: string[];\n} {\n  const ignoredTags = new Set(['br', 'head', 'link', 'meta', 'script', 'style']);\n  const classes: Set<string> = new Set();\n  const hrefs: Set<string> = new Set();\n  const ids: Set<string> = new Set();\n\n  for (const element of elements) {\n    if (element.nodeType !== 1 /* Node.ELEMENT_NODE */) {\n      continue;\n    }\n\n    if (element.localName !== undefined && ignoredTags.has(element.localName)) {\n      continue;\n    }\n\n    // Update ids\n    const id = element.id;\n    if (id) {\n      ids.add(id);\n    }\n\n    // Update classes\n    const classList = element.classList;\n    if (classList) {\n      for (const cls of classList) {\n        classes.add(cls);\n      }\n    }\n\n    // Update href\n    const href = element.href;\n    if (typeof href === 'string') {\n      hrefs.add(href);\n    }\n  }\n\n  return {\n    classes: Array.from(classes),\n    hrefs: Array.from(hrefs),\n    ids: Array.from(ids),\n  };\n}\n\nexport class DOMMonitor {\n  private knownIds: Set<string> = new Set();\n  private knownHrefs: Set<string> = new Set();\n  private knownClasses: Set<string> = new Set();\n\n  private observer: MutationObserver | null = null;\n\n  constructor(\n    private readonly cb: (features: { ids: string[]; classes: string[]; hrefs: string[] }) => void,\n  ) {}\n\n  public queryAll(window: Pick<Window, 'document'>): void {\n    this.handleNewNodes(Array.from(window.document.querySelectorAll('[id],[class],[href]')));\n  }\n  public start(\n    window: Pick<Window, 'document'> & { MutationObserver?: typeof MutationObserver },\n  ): void {\n    if (this.observer === null && window.MutationObserver !== undefined) {\n      this.observer = new window.MutationObserver((mutations: MutationRecord[]) => {\n        this.handleNewNodes(getDOMElementsFromMutations(mutations));\n      });\n\n      this.observer.observe(window.document.documentElement, {\n        attributeFilter: ['class', 'id', 'href'],\n        attributes: true,\n        childList: true,\n        subtree: true,\n      });\n    }\n  }\n\n  public stop(): void {\n    if (this.observer !== null) {\n      this.observer.disconnect();\n      this.observer = null;\n    }\n  }\n\n  public handleNewFeatures({\n    hrefs,\n    ids,\n    classes,\n  }: {\n    hrefs: string[];\n    ids: string[];\n    classes: string[];\n  }): boolean {\n    const newIds: string[] = [];\n    const newClasses: string[] = [];\n    const newHrefs: string[] = [];\n\n    // Update ids\n    for (const id of ids) {\n      if (this.knownIds.has(id) === false) {\n        newIds.push(id);\n        this.knownIds.add(id);\n      }\n    }\n\n    for (const cls of classes) {\n      if (this.knownClasses.has(cls) === false) {\n        newClasses.push(cls);\n        this.knownClasses.add(cls);\n      }\n    }\n\n    for (const href of hrefs) {\n      if (this.knownHrefs.has(href) === false) {\n        newHrefs.push(href);\n        this.knownHrefs.add(href);\n      }\n    }\n\n    if (newIds.length !== 0 || newClasses.length !== 0 || newHrefs.length !== 0) {\n      this.cb({\n        classes: newClasses,\n        hrefs: newHrefs,\n        ids: newIds,\n      });\n      return true;\n    }\n\n    return false;\n  }\n\n  private handleNewNodes(nodes: DOMElement[]): boolean {\n    return this.handleNewFeatures(extractFeaturesFromDOM(nodes));\n  }\n}\n\n/**\n * Wrap a self-executing script into a block of custom logic to remove the\n * script tag once execution is terminated. This can be useful to not leave\n * traces in the DOM after injections.\n */\nexport function autoRemoveScript(script: string): string {\n  // Minified using 'terser'\n  return `try{${script}}catch(c){}!function(){var c=document.currentScript,e=c&&c.parentNode;e&&e.removeChild(c)}();`;\n  // Original:\n  //\n  //    try {\n  //      ${script}\n  //    } catch (ex) { }\n  //\n  //    (function() {\n  //      var currentScript = document.currentScript;\n  //      var parent = currentScript && currentScript.parentNode;\n  //\n  //      if (parent) {\n  //        parent.removeChild(currentScript);\n  //      }\n  //    })();\n}\n\nexport function injectCSSRule(rule: string, doc: Document): void {\n  const parent = doc.head || doc.getElementsByTagName('head')[0] || doc.documentElement;\n  if (parent !== null) {\n    const css = doc.createElement('style');\n    css.type = 'text/css';\n    css.id = 'cliqz-adblokcer-css-rules';\n    css.appendChild(doc.createTextNode(rule));\n    parent.appendChild(css);\n  }\n}\n\nexport function injectScript(s: string, doc: Document): void {\n  const script = doc.createElement('script');\n  script.type = 'text/javascript';\n  script.id = 'cliqz-adblocker-script';\n  script.async = false;\n  script.appendChild(doc.createTextNode(autoRemoveScript(s)));\n\n  // Insert node\n  const parent = doc.head || doc.documentElement;\n  if (parent !== null) {\n    parent.appendChild(script);\n  }\n}\n"],"names":["getDOMElementsFromMutations","mutations","mutation","type","nodes","push","target","addedNode","undefined","addedDOMElement","querySelectorAll","extractFeaturesFromDOM","elements","element","nodeType","localName","ignoredTags","has","ids","add","id","classes","cls","href","hrefs","Array","from","autoRemoveScript","script","DOMMonitor","cb","knownIds","Set","knownHrefs","knownClasses","observer","window","handleNewNodes","document","MutationObserver","observe","documentElement","attributeFilter","attributes","childList","subtree","disconnect","newIds","newClasses","newHrefs","length","handleNewFeatures","rule","doc","parent","css","appendChild","createTextNode","s","async"],"mappings":"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"}